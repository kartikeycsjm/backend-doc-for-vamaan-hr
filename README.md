# Frappe Backend Guide: Geofencing Attendance App

## 1. Objective & Core Principle

**Goal**: Track employee attendance using **geofencing** and **face recognition**, along with real-time location logs.

**Main Idea**: All data we add (like geofence zones or face data) should connect directly to Frappe’s built-in **Employee** DocType. That way, everything works smoothly with ERPNext’s HR, payroll, and reports.

---

## 2. Data Modeling (Custom DocTypes)

We will create 3 custom DocTypes, each connected to `Employee`:

### 2.1 Employee Geofence

Stores **employee location settings** (work site & allowed radius).

| Label            | Fieldname | Type   | Mandatory | Notes                            |
|------------------|-----------|--------|-----------|----------------------------------|
| Employee         | employee  | Link   | ✅        | Link to standard Employee DocType |
| Latitude         | latitude  | Float  | ✅        | Use 9 decimal precision          |
| Longitude        | longitude | Float  | ✅        | Use 9 decimal precision          |
| Radius (Meters)  | radius    | Float  | ✅        | Radius of allowed location area  |

---

### 2.2 Face Embedding

Stores **numerical face representations** generated by AI models.

| Label         | Fieldname       | Type      | Mandatory | Notes                        |
|---------------|------------------|-----------|-----------|------------------------------|
| Employee      | employee         | Link      | ✅        | Link to Employee             |
| Embedding JSON| embedding_json   | Long Text | ✅        | Large array of floats (face data) |
| Device Details| device_details   | Data      | ❌        | Optional device info for audit |

---

### 2.3 Location Log (for live tracking)

Logs **employee GPS coordinates** at regular intervals (every few mins).

| Label     | Fieldname | Type     | Mandatory | Index | Notes                                |
|-----------|-----------|----------|-----------|-------|--------------------------------------|
| Employee  | employee  | Link     | ✅        | ✅    | For fast filtering                    |
| Timestamp | timestamp | Datetime | ✅        | ✅    | For date-range queries               |
| Latitude  | latitude  | Float    | ✅        | ❌    |                                      |
| Longitude | longitude | Float    | ✅        | ❌    |                                      |

Caution- Keep this DocType **lightweight**. Avoid adding extra fields — it is used for **fast map queries**.

---

## 3. API Specification

### 3.1 Authentication: Token-Based Login

1. **Endpoint**: `POST /api/method/login`
2. **Request Body**:
```json
{
  "usr": "employee@email.com",
  "pwd": "password"
}
```
3. **Response**:
```json
{
  "api_key": "...",
  "api_secret": "..."
}
```
4. App must store this securely.

5. Future requests should include:
```http
Authorization: token {api_key}:{api_secret}
```

---

### 3.2 Get Employee Data (Custom API)

Fetches **geofence & face data** on login.

- **Endpoint**:
```
GET /api/method/attendance_app.api.get_employee_login_data?employee_id=HR-EMP-00001
```

- **Response**:
```json
{
  "full_name": "John Doe",
  "geofence": {
    "latitude": 26.4499,
    "longitude": 80.3319,
    "radius": 10
  },
  "face_embeddings": [
    [0.123, -0.456, ...],
    [-0.789, 0.101, ...]
  ]
}
```

---

### 3.3 Log Employee Location

Used by background location tracker.

- **Endpoint**: `POST /api/method/attendance_app.api.log_location`

- **Request**:
```json
{
  "employee": "HR-EMP-00001",
  "latitude": 26.4501,
  "longitude": 80.3325
}
```

---

### 3.4 Mark Attendance (Standard DocType)

- **Endpoint**: `POST /api/resource/Attendance`

- **Request**:
```json
{
  "employee": "HR-EMP-00001",
  "log_type": "IN",
  "attendance_date": "2025-08-04"
}
```

---

## 4. Python API (File: `attendance_app/api.py`)

```python
import frappe
import json
from frappe.utils import now_datetime

@frappe.whitelist()
def get_employee_login_data(employee_id):
    geofence = frappe.get_value("Employee Geofence", {"employee": employee_id}, ["latitude", "longitude", "radius"], as_dict=True)
    if not geofence:
        frappe.throw(f"Geofence data not found for Employee: {employee_id}")

    embeddings_docs = frappe.get_all("Face Embedding", filters={"employee": employee_id}, fields=["embedding_json"])
    embeddings = [json.loads(e.get("embedding_json")) for e in embeddings_docs]
    full_name = frappe.db.get_value("Employee", employee_id, "employee_name")

    return {
        "full_name": full_name,
        "geofence": geofence,
        "face_embeddings": embeddings
    }

@frappe.whitelist()
def log_location(employee, latitude, longitude):
    doc = frappe.new_doc("Location Log")
    doc.employee = employee
    doc.latitude = latitude
    doc.longitude = longitude
    doc.timestamp = now_datetime()
    doc.insert(ignore_permissions=True)
    return {"status": "success"}

@frappe.whitelist()
def get_employee_path(employee, date):
    start_datetime = f"{date} 00:00:00"
    end_datetime = f"{date} 23:59:59"

    path = frappe.get_all(
        "Location Log",
        filters={"employee": employee, "timestamp": ["between", (start_datetime, end_datetime)]},
        fields=["latitude", "longitude"],
        order_by="timestamp asc"
    )
    return [list(p.values()) for p in path]
```

---

## 5. Building the Live Map View (Frappe UI)

### Step 1: Create Page

In Frappe UI:

- Go to **Page List** → Create new page
- Name: `Live Employee Map`
- Module: `attendance_app`

### Step 2: Add Code

This creates:

- `live_employee_map.js` (logic)
- `live_employee_map.html` (optional)
- `live_employee_map.py`

### Sample JS (`live_employee_map.js`)

```js
frappe.pages['live-employee-map'].on_page_load = function(wrapper) {
    let page = frappe.ui.make_app_page({
        parent: wrapper,
        title: 'Live Employee Map',
        single_column: true
    });

    $(wrapper).find(".page-content").html(`
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
        <div class="map-filters row">
            <div class="col-md-4"><div id="employee-filter"></div></div>
            <div class="col-md-4"><div id="date-filter"></div></div>
            <div class="col-md-2"><button class="btn btn-primary" id="search-btn">Show Path</button></div>
        </div>
        <div id="map" style="height: 600px; margin-top: 15px;"></div>
    `);

    let employee_filter = frappe.ui.form.make_control({
        parent: $(wrapper).find('#employee-filter'),
        df: { fieldtype: 'Link', options: 'Employee', label: 'Employee', fieldname: 'employee' },
        render_input: true,
    });

    let date_filter = frappe.ui.form.make_control({
        parent: $(wrapper).find('#date-filter'),
        df: { fieldtype: 'Date', label: 'Date', fieldname: 'date', default: frappe.datetime.get_today() },
        render_input: true,
    });

    let map = L.map('map').setView([26.4499, 80.3319], 13);  // Centered on Kanpur
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    let path_layer = null;

    $(wrapper).find('#search-btn').on('click', function() {
        let employee = employee_filter.get_value();
        let date = date_filter.get_value();
        if (!employee || !date) {
            frappe.msgprint("Please select an Employee and a Date.");
            return;
        }

        frappe.call({
            method: "attendance_app.attendance_app.api.get_employee_path",
            args: { employee: employee, date: date },
            callback: function(r) {
                if (r.message && r.message.length > 0) {
                    let path_coords = r.message;
                    if (path_layer) map.removeLayer(path_layer);
                    path_layer = L.polyline(path_coords, {color: 'blue'}).addTo(map);
                    L.marker(path_coords[0]).addTo(path_layer).bindPopup("Start");
                    L.marker(path_coords[path_coords.length - 1]).addTo(path_layer).bindPopup("End");
                    map.fitBounds(path_layer.getBounds());
                } else {
                    frappe.msgprint("No location data found for this employee on the selected date.");
                }
            }
        });
    });
}
```

---

## Summary

This backend system gives you:

- Secure login via tokens
-  Geofence & face embedding management
-  Real-time GPS logging
-  Daily attendance submission
-  A live map to view employee movement

This is ready to connect with a mobile app (React Native or others) and is fully compatible with ERPNext.

## Author Details

* **Name:** Kartikey Mishra
* **Guide Created:** August 6, 2025
* **Location:** Kanpur, Uttar Pradesh, India
---
